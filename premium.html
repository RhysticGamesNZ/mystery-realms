<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Premium Membership – Mystery Realms</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
<div id="site-content">

  <header class="site-header">
    <div class="header-container">
      <div class="logo">
        <img src="./logo.png" alt="Mystery Realms Logo" />
      </div>
      <nav class="nav-links">
        <a href="index.html">Mystery</a>
        <a href="past.html">Past Mysteries</a>
        <a href="lore.html">Lore & Codex</a>
        <a href="stats.html">Stats</a>
        <a href="premium.html">Premium</a>
      </nav>
      <div class="hamburger" id="hamburger-icon">&#9776;</div>
    </div>
  </header>

  <div class="page-wrapper">
    <div id="ad-left" class="ad-left">
      <ins class="adsbygoogle" style="display:block;width:120px;height:600px" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="1111111111"></ins>
    </div>

<!-- Checkout view (default if not premium) -->
<main class="card parchment" id="premium-checkout" style="display: none;">
  <h2 class="header1" style="text-align: center;">Take the Obscura Pact</h2>
  <div class="premium-flex">
    <p class="prem-join">Unlock the deeper layers of Gloomark. <br>
      These aren’t just more cases. They’re the ones the Archive doesn’t want opened.<br>
    As a Premium Seeker, you gain access to:</p>
    <ul class="prem-list">
      <li><img class="stat-image" src="./candle.png" alt="candle"> Weekly Premium Mysteries every Monday</li>
      <li><img class="stat-image" src="./old-book.png" alt="old book"> Decide where the story will go next!</li>
      <li><img class="stat-image" src="./ancient-scroll.png" alt="ancient scroll"> Early access to lore expansions</li>
      <li><img class="stat-image" src="./ad-banner.png" alt="ad free"> No ads across the site</li>
    </ul>
  </div>
  <div style="text-align: center;">
    <button id="checkout-button" class="premium-button">Subscribe Now</button>
  </div>
</main>

<!-- Premium content view (if subscribed) -->
<main class="card parchment" id="premium-content" style="display: none;">
  <h2>✨ Welcome, Premium Seeker!</h2>
  <section id="premium-mystery">
    <h3 id="mystery-title">Loading mystery...</h3>
    <p id="mystery-premise"></p>
    <ul id="mystery-clues"></ul>
    <form id="mystery-form">
      <fieldset id="mystery-choices"></fieldset>
      <button type="submit">Submit Decision</button>
    </form>
    <div id="mystery-result"></div>
  </section>
</main>

    <div id="ad-right" class="ad-right">
      <ins class="adsbygoogle" style="display:block;width:120px;height:600px" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="2222222222"></ins>
    </div>
  </div>

  <div id="ad-bottom" class="ad-bottom">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXXXXXXXX" data-ad-slot="3333333333" data-ad-format="auto" data-full-width-responsive="true"></ins>
  </div>

  <footer class="footer">
    <p>&copy; Rhystic Games 2025</p>
    <a href='https://ko-fi.com/G2G81E6E2Y' target='_blank'><img height='36' style='border:0px;height:36px;' src='https://storage.ko-fi.com/cdn/kofi1.png?v=6' border='0' alt='Buy Me a Coffee at ko-fi.com' /></a>
  </footer>

</div>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  (adsbygoogle = window.adsbygoogle || []).push({});
  (adsbygoogle = window.adsbygoogle || []).push({});
</script>

<script src="https://js.stripe.com/v3/"></script>

<!-- Firebase + Stripe -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDXY7DEhinmbYLQ7zBRgEUJoc_eRsp-aNU",
  authDomain: "mystery-realms.firebaseapp.com",
  projectId: "mystery-realms",
  storageBucket: "mystery-realms.firebasestorage.app",
  messagingSenderId: "511471364499",
  appId: "1:511471364499:web:fbc7d813e9b8d28cf32066"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const checkoutContainer = document.getElementById("premium-checkout");
const premiumContainer = document.getElementById("premium-content");

onAuthStateChanged(auth, async (user) => {
  if (user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    if (userDoc.exists() && userDoc.data().premium) {
      checkoutContainer.style.display = "none";
      premiumContainer.style.display = "block";
      loadPremiumMystery(user.uid);
    } else {
      checkoutContainer.style.display = "block";
      premiumContainer.style.display = "none";
    }
  } else {
    checkoutContainer.style.display = "block";
    premiumContainer.style.display = "none";
  }
});

async function loadPremiumMystery(userId) {
  const today = new Date();
  today.setUTCHours(0, 0, 0, 0);
  const monday = new Date(today);
  monday.setUTCDate(monday.getUTCDate() - ((monday.getUTCDay() + 6) % 7));
  const start = Timestamp.fromDate(monday);
  const end = Timestamp.fromDate(new Date(monday.getTime() + 7 * 24 * 60 * 60 * 1000));

  const q = query(
    collection(db, "weeklyMysteries"),
    where("date", ">=", start),
    where("date", "<", end)
  );

  const snapshot = await getDocs(q);
  snapshot.forEach((docSnap) => {
    const data = docSnap.data();
    document.getElementById("mystery-title").textContent = data.title;
    document.getElementById("mystery-premise").textContent = data.premise;
    const clues = document.getElementById("mystery-clues");
    clues.innerHTML = "";
    for (let i = 1; i <= 5; i++) {
      if (data[`day${i}clue`]) {
        const li = document.createElement("li");
        li.textContent = data[`day${i}clue`];
        clues.appendChild(li);
      }
    }
    const choicesFieldset = document.getElementById("mystery-choices");
    choicesFieldset.innerHTML = "";
    data.choices.forEach(choice => {
      const label = document.createElement("label");
      const input = document.createElement("input");
      input.type = "radio";
      input.name = "premium-choice";
      input.value = choice;
      label.appendChild(input);
      label.appendChild(document.createTextNode(choice));
      choicesFieldset.appendChild(label);
    });

    document.getElementById("mystery-form").onsubmit = async (e) => {
      e.preventDefault();
      const selected = document.querySelector("input[name='premium-choice']:checked");
      if (!selected) return;

      const choiceMade = selected.value;

      // Save the user's choice in a "weeklyChoices" collection
      await addDoc(collection(db, "weeklyChoices"), {
        userId: userId,
        choice: choiceMade,
        timestamp: Timestamp.now(),
        weeklyMysteryId: docSnap.id
      });

      document.getElementById("mystery-result").innerHTML = `<p>✅ You chose: <strong>${choiceMade}</strong>. Thank you, Seeker.</p>`;
    };
  });
}

// Stripe button
const checkoutButton = document.getElementById('checkout-button');
checkoutButton.addEventListener('click', async () => {
  const stripe = Stripe('pk_live_51RHbVmDN3UWo9IgN2cmBCfP9bB6UEW6sRwGiaEruXAz6XzCPurlzqcGJf8VYpb3a2I7G4cdUK6dBOv0MkjLAPgmv00s42wtmzi');
  checkoutButton.textContent = "Redirecting...";
  checkoutButton.disabled = true;
  await stripe.redirectToCheckout({
    lineItems: [{ price: 'price_1RIKt2DN3UWo9IgNhJaL8v1L', quantity: 1 }],
    mode: 'subscription',
    successUrl: 'https://rhysticgamesnz.github.io/mystery-realms/stats.html',
    cancelUrl: 'https://rhysticgamesnz.github.io/mystery-realms/premium.html',
  });
});
</script>

<script>
  document.getElementById("hamburger-icon").addEventListener("click", function () {
    const navLinks = document.querySelector(".nav-links");
    const logo = document.querySelector(".logo");
    navLinks.classList.toggle("active");
    logo.style.display = navLinks.classList.contains("active") ? "none" : "block";
  });
</script>

</body>
</html>
